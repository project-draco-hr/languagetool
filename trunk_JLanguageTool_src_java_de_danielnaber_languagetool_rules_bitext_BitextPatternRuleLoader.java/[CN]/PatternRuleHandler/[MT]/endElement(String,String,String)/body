{
  if (qName.equals("source")) {
    if (phraseElementList == null || phraseElementList.size() == 0) {
      final int endMarker=elementList.size() + endPositionCorrection;
      if (endMarker <= startPositionCorrection) {
        throw new RuntimeException("Invalid combination of mark_from (" + startPositionCorrection + ") and mark_to ("+ endPositionCorrection+ ") for rule "+ id+ " with "+ elementList.size()+ " tokens: the error position created by mark_from and mark_to is less than one token");
      }
    }
    srcRule=finalizeRule();
  }
 else   if (qName.equals("target")) {
    if (phraseElementList == null || phraseElementList.size() == 0) {
      final int endMarker=elementList.size() + endPositionCorrection;
      if (endMarker <= startPositionCorrection) {
        throw new RuntimeException("Invalid combination of mark_from (" + startPositionCorrection + ") and mark_to ("+ endPositionCorrection+ ") for rule "+ id+ " with "+ elementList.size()+ " tokens: the error position created by mark_from and mark_to is less than one token");
      }
    }
    trgRule=finalizeRule();
  }
 else   if (qName.equals("rule")) {
    BitextPatternRule bRule=new BitextPatternRule(srcRule,trgRule);
    bRule.setCorrectBitextExamples(correctExamples);
    bRule.setIncorrectBitextExamples(incorrectExamples);
    bRule.setSourceLang(srcLang);
    rules.add(bRule);
  }
 else   if (qName.equals("exception")) {
    inException=false;
    if (!exceptionSet) {
      tokenElement=new Element(StringTools.trimWhitespace(elements.toString()),caseSensitive,stringRegExp,tokenInflected);
      exceptionSet=true;
    }
    tokenElement.setNegation(tokenNegated);
    if (!StringTools.isEmpty(exceptions.toString())) {
      tokenElement.setStringException(StringTools.trimWhitespace(exceptions.toString()),exceptionStringRegExp,exceptionStringInflected,exceptionStringNegation,exceptionValidNext,exceptionValidPrev);
    }
    if (exceptionPosToken != null) {
      tokenElement.setPosException(exceptionPosToken,exceptionPosRegExp,exceptionPosNegation,exceptionValidNext,exceptionValidPrev);
      exceptionPosToken=null;
    }
    if (exceptionSpaceBeforeSet) {
      tokenElement.setExceptionSpaceBefore(exceptionSpaceBefore);
    }
    resetException();
  }
 else   if (qName.equals("and")) {
    inAndGroup=false;
    andGroupCounter=0;
    tokenCounter++;
  }
 else   if (qName.equals("token")) {
    if (!exceptionSet || tokenElement == null) {
      tokenElement=new Element(StringTools.trimWhitespace(elements.toString()),caseSensitive,stringRegExp,tokenInflected);
      tokenElement.setNegation(tokenNegated);
    }
 else {
      tokenElement.setStringElement(StringTools.trimWhitespace(elements.toString()));
    }
    if (skipPos != 0) {
      tokenElement.setSkipNext(skipPos);
      skipPos=0;
    }
    if (posToken != null) {
      tokenElement.setPosElement(posToken,posRegExp,posNegation);
      posToken=null;
    }
    if (tokenReference != null) {
      tokenElement.setMatch(tokenReference);
    }
    if (inAndGroup && andGroupCounter > 0) {
      elementList.get(elementList.size() - 1).setAndGroupElement(tokenElement);
    }
 else {
      elementList.add(tokenElement);
    }
    if (inAndGroup) {
      andGroupCounter++;
    }
    if (inUnification) {
      tokenElement.setUnification(equivalenceFeatures);
      if (uniNegation) {
        tokenElement.setUniNegation();
      }
    }
    if (inUnificationDef) {
      language.getUnifier().setEquivalence(uFeature,uType,tokenElement);
      elementList.clear();
    }
    if (tokenSpaceBeforeSet) {
      tokenElement.setWhitespaceBefore(tokenSpaceBefore);
    }
    resetToken();
  }
 else   if (qName.equals("pattern")) {
    inPattern=false;
    if (lastPhrase) {
      elementList.clear();
    }
    if (phraseElementList == null || phraseElementList.isEmpty()) {
      checkPositions(0);
    }
 else {
      for (      List<Element> elements : phraseElementList) {
        checkPositions(elements.size());
      }
    }
    tokenCounter=0;
  }
 else   if (qName.equals("trgExample")) {
    trgExample=setExample();
  }
 else   if (qName.equals("srcExample")) {
    srcExample=setExample();
  }
 else   if (qName.equals("example")) {
    if (inCorrectExample) {
      correctExamples.add(new StringPair(srcExample.getExample(),trgExample.getExample()));
    }
 else     if (inIncorrectExample) {
      if (trgExample.getCorrections() == null) {
        incorrectExamples.add(new IncorrectBitextExample(new StringPair(srcExample.getExample(),trgExample.getExample())));
      }
 else {
        incorrectExamples.add(new IncorrectBitextExample(new StringPair(srcExample.getExample(),trgExample.getExample()),(String[])trgExample.getCorrections().toArray()));
      }
    }
    inCorrectExample=false;
    inIncorrectExample=false;
  }
 else   if (qName.equals("message")) {
    suggestionMatches=addLegacyMatches();
    inMessage=false;
  }
 else   if (qName.equals("short")) {
    inShortMessage=false;
  }
 else   if (qName.equals("match")) {
    if (inMessage) {
      suggestionMatches.get(suggestionMatches.size() - 1).setLemmaString(match.toString());
    }
 else     if (inToken) {
      tokenReference.setLemmaString(match.toString());
    }
    inMatch=false;
  }
 else   if (qName.equals("rulegroup")) {
    inRuleGroup=false;
  }
 else   if (qName.equals("suggestion") && inMessage) {
    message.append("</suggestion>");
  }
 else   if (qName.equals(MARKER) && inCorrectExample) {
    correctExample.append("</marker>");
  }
 else   if (qName.equals(MARKER) && inIncorrectExample) {
    incorrectExample.append("</marker>");
  }
 else   if (qName.equals("phrase") && inPhrases) {
    if (phraseMap == null) {
      phraseMap=new HashMap<String,List<List<Element>>>();
    }
    phraseElementInit();
    if (phraseElementList.isEmpty()) {
      phraseElementList.add(new ArrayList<Element>(elementList));
    }
 else {
      for (      final ArrayList<Element> ph : phraseElementList) {
        ph.addAll(new ArrayList<Element>(elementList));
      }
    }
    phraseMap.put(phraseId,new ArrayList<List<Element>>(phraseElementList));
    elementList.clear();
    phraseElementList.clear();
  }
 else   if (qName.equals("includephrases")) {
    elementList.clear();
  }
 else   if (qName.equals("phrases") && inPhrases) {
    inPhrases=false;
  }
 else   if (qName.equals("unification")) {
    inUnificationDef=false;
  }
 else   if (qName.equals("feature")) {
    equivalenceFeatures.put(uFeature,uTypeList);
    uTypeList=new ArrayList<String>();
  }
 else   if (qName.equals("unify")) {
    inUnification=false;
    equivalenceFeatures=new HashMap<String,List<String>>();
  }
}
