{
  Locale charLocale;
  try {
    if (xFlatPI == null) {
      return null;
    }
    final com.sun.star.text.XFlatParagraphIterator xParaAccess=xFlatPI.getFlatParagraphIterator(com.sun.star.text.TextMarkupType.GRAMMAR,true);
    if (xParaAccess == null) {
      System.err.println("xParaAccess == null");
      return null;
    }
    com.sun.star.text.XFlatParagraph xParaEnum=xParaAccess.getFirstPara();
    if (xParaEnum == null) {
      xParaEnum=xParaAccess.getNextPara();
      if (xParaEnum == null) {
        return null;
      }
    }
    int maxLen=xParaEnum.getText().length();
    if (maxLen > 200) {
      maxLen=200;
    }
    charLocale=xParaEnum.getPrimaryLanguageOfText(1,maxLen);
    if (!hasLocale(charLocale)) {
      final DialogThread dt=new DialogThread("Error: Sorry, the document language '" + charLocale.Language + "' is not supported by LanguageTool.");
      dt.start();
      return null;
    }
  }
 catch (  final Exception e) {
    throw new RuntimeException(e);
  }
  return Language.getLanguageForShortName(charLocale.Language);
}
