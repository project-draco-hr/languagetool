{
  for (  Map.Entry<String,Long> entry : ngramToCount.entrySet()) {
    Term ngram=new Term("ngram",entry.getKey());
    reader=DirectoryReader.open(indexWriter,true);
    searcher=new IndexSearcher(reader);
    TopDocs topDocs=searcher.search(new TermQuery(ngram),2);
    if (topDocs.totalHits == 0) {
      Document doc=getDoc(entry.getKey(),entry.getValue());
      indexWriter.addDocument(doc);
    }
 else     if (topDocs.totalHits == 1) {
      int docNumber=topDocs.scoreDocs[0].doc;
      Document document=reader.document(docNumber);
      long oldCount=Long.parseLong(document.getField("count").stringValue());
      indexWriter.deleteDocuments(ngram);
      indexWriter.addDocument(getDoc(entry.getKey(),oldCount + entry.getValue()));
    }
 else     if (topDocs.totalHits > 1) {
      throw new RuntimeException("Got more than one hit for: " + ngram);
    }
  }
  indexWriter.commit();
}
