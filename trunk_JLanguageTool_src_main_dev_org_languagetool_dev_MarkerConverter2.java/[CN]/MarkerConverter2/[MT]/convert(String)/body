{
  initStartAndEndPositions();
  final XMLInputFactory inputFactory=XMLInputFactory.newInstance();
  inputFactory.setProperty(XMLInputFactory.IS_REPLACING_ENTITY_REFERENCES,false);
  final InputStream in=new FileInputStream(filename);
  final XMLStreamReader streamReader=inputFactory.createXMLStreamReader(in);
  while (streamReader.hasNext()) {
    final int eventType=streamReader.next();
    if (eventType == XMLStreamConstants.COMMENT) {
      if (streamReader.hasText()) {
        System.out.print("<!--" + streamReader.getText() + "-->");
      }
    }
 else     if (eventType == XMLStreamConstants.CHARACTERS) {
      if (streamReader.hasText()) {
        System.out.print(StringTools.escapeXML(streamReader.getText()));
      }
    }
 else {
      if (eventType == XMLStreamConstants.START_ELEMENT) {
        final String localName=streamReader.getLocalName();
        initMarkFromAndMarkTo(streamReader);
        if (localName.equals("rulegroup")) {
          currentSubId=0;
          inRuleGroup=true;
          currentTokenPos=0;
        }
 else         if (localName.equals("rule")) {
          currentTokenPos=0;
          if (inRuleGroup) {
            currentSubId++;
          }
 else {
            currentSubId=1;
          }
        }
 else         if (localName.equals("pattern")) {
          final boolean defaultStart=mark_from == Integer.MAX_VALUE || mark_from == 0;
          final boolean defaultEnd=mark_to == Integer.MAX_VALUE || mark_to == 0;
          needsMarker=!defaultStart || !defaultEnd;
        }
 else         if (localName.equals("token")) {
          final String key=currentId + " " + currentSubId;
          if (needsMarker && startPos.get(key) == currentTokenPos) {
            System.out.print("<marker>\n");
          }
          currentTokenPos++;
        }
        printStartTag(streamReader,localName);
      }
 else       if (eventType == XMLStreamConstants.END_ELEMENT) {
        final String localName=streamReader.getLocalName();
        System.out.print("</" + localName + ">");
        if (localName.equals("rulegroup")) {
          inRuleGroup=false;
        }
 else         if (localName.equals("token")) {
          final String key=currentId + " " + currentSubId;
          if (needsMarker && endPos.get(key) == currentTokenPos) {
            System.out.print("\n</marker>");
          }
        }
      }
 else       if (eventType == XMLStreamConstants.ENTITY_REFERENCE) {
        final String localName=streamReader.getLocalName();
        System.out.print("&" + localName + ";");
      }
    }
  }
}
