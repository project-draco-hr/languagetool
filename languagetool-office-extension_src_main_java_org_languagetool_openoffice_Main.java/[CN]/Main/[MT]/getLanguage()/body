{
  final XComponent xComponent=getXComponent();
  final Locale charLocale;
  final XPropertySet xCursorProps;
  try {
    final XModel model=(XModel)UnoRuntime.queryInterface(XModel.class,xComponent);
    final XTextViewCursorSupplier xViewCursorSupplier=(XTextViewCursorSupplier)UnoRuntime.queryInterface(XTextViewCursorSupplier.class,model.getCurrentController());
    final XTextViewCursor xCursor=xViewCursorSupplier.getViewCursor();
    if (xCursor.isCollapsed()) {
      xCursorProps=(XPropertySet)UnoRuntime.queryInterface(XPropertySet.class,xCursor);
    }
 else {
      xCursorProps=(XPropertySet)UnoRuntime.queryInterface(XPropertySet.class,xCursor.getText().createTextCursorByRange(xCursor.getStart()));
    }
    final KhmerDetector khmerDetector=new KhmerDetector();
    if (khmerDetector.isKhmer(xCursor.getText().getString())) {
      return Language.getLanguageForShortName("km");
    }
    final Object obj=xCursorProps.getPropertyValue("CharLocale");
    if (obj == null) {
      return Language.getLanguageForShortName("en-US");
    }
    charLocale=(Locale)obj;
    boolean langIsSupported=false;
    for (    Language element : Language.LANGUAGES) {
      if (element.getShortName().equals(charLocale.Language)) {
        langIsSupported=true;
        break;
      }
    }
    if (!langIsSupported) {
      final String message=org.languagetool.gui.Tools.makeTexti18n(MESSAGES,"language_not_supported",charLocale.Language);
      JOptionPane.showMessageDialog(null,message);
      return null;
    }
  }
 catch (  final Throwable t) {
    showError(t);
    return null;
  }
  try {
    if (!charLocale.Variant.isEmpty()) {
      return Language.getLanguageForShortName(charLocale.Language + "-" + charLocale.Country+ "-"+ charLocale.Variant);
    }
 else {
      return Language.getLanguageForShortName(charLocale.Language + "-" + charLocale.Country);
    }
  }
 catch (  java.lang.IllegalArgumentException e) {
    return Language.getLanguageForShortName(charLocale.Language);
  }
}
