{
  long timeStart=System.currentTimeMillis();
  if (text.length() > maxTextLength) {
    throw new TextTooLongException("Your text exceeds this server's limit of " + maxTextLength + " characters (it's "+ text.length()+ " characters). Please submit a shorter text.");
  }
  boolean autoDetectLanguage=getLanguageAutoDetect(parameters);
  Language lang=getLanguage(text,parameters.get("language"),autoDetectLanguage);
  String motherTongueParam=parameters.get("motherTongue");
  Language motherTongue=motherTongueParam != null ? Languages.getLanguageForShortName(motherTongueParam) : null;
  boolean useEnabledOnly="yes".equals(parameters.get("enabledOnly"));
  String enabledParam=parameters.get("enabled");
  List<String> enabledRules=new ArrayList<>();
  if (enabledParam != null) {
    enabledRules.addAll(Arrays.asList(enabledParam.split(",")));
  }
  List<String> disabledRules=getCommaSeparatedStrings("disabled",parameters);
  List<CategoryId> enabledCategories=getCategoryIds("enabledCategories",parameters);
  List<CategoryId> disabledCategories=getCategoryIds("disabledCategories",parameters);
  if ((disabledRules.size() > 0 || disabledCategories.size() > 0) && useEnabledOnly) {
    throw new IllegalArgumentException("You cannot specify disabled rules or categories using enabledOnly=yes");
  }
  boolean useQuerySettings=enabledRules.size() > 0 || disabledRules.size() > 0 || enabledCategories.size() > 0 || disabledCategories.size() > 0;
  QueryParams params=new QueryParams(enabledRules,disabledRules,enabledCategories,disabledCategories,useEnabledOnly,useQuerySettings);
  Future<List<RuleMatch>> future=executorService.submit(new Callable<List<RuleMatch>>(){
    @Override public List<RuleMatch> call() throws Exception {
      return getRuleMatches(text,parameters,lang,motherTongue,params);
    }
  }
);
  List<RuleMatch> matches;
  if (maxCheckTimeMillis < 0) {
    matches=future.get();
  }
 else {
    try {
      matches=future.get(maxCheckTimeMillis,TimeUnit.MILLISECONDS);
    }
 catch (    ExecutionException e) {
      if (e.getCause() != null && e.getCause() instanceof OutOfMemoryError) {
        throw (OutOfMemoryError)e.getCause();
      }
 else {
        throw e;
      }
    }
catch (    TimeoutException e) {
      boolean cancelled=future.cancel(true);
      throw new RuntimeException("Text checking took longer than allowed maximum of " + maxCheckTimeMillis + " milliseconds (cancelled: "+ cancelled+ ", handleCount: "+ handleCount+ ", queue size: "+ workQueue.size()+ ", language: "+ lang.getShortNameWithCountryAndVariant()+ ", "+ text.length()+ " characters of text)",e);
    }
  }
  setCommonHeaders(httpExchange);
  String xmlResponse=getXmlResponse(text,lang,motherTongue,matches);
  String messageSent="sent";
  String languageMessage=lang.getShortNameWithCountryAndVariant();
  String referrer=httpExchange.getRequestHeaders().getFirst("Referer");
  try {
    httpExchange.sendResponseHeaders(HttpURLConnection.HTTP_OK,xmlResponse.getBytes(ENCODING).length);
    httpExchange.getResponseBody().write(xmlResponse.getBytes(ENCODING));
    if (motherTongue != null) {
      languageMessage+=" (mother tongue: " + motherTongue.getShortNameWithCountryAndVariant() + ")";
    }
    if (autoDetectLanguage) {
      languageMessage+="[auto]";
    }
  }
 catch (  IOException exception) {
    messageSent="notSent: " + exception.getMessage();
  }
  String agent=parameters.get("useragent") != null ? parameters.get("useragent") : "-";
  print("Check done: " + text.length() + " chars, "+ languageMessage+ ", "+ referrer+ ", "+ "handlers:"+ handleCount+ ", queue:"+ workQueue.size()+ ", "+ matches.size()+ " matches, "+ (System.currentTimeMillis() - timeStart)+ "ms, agent:"+ agent+ ", "+ messageSent);
}
