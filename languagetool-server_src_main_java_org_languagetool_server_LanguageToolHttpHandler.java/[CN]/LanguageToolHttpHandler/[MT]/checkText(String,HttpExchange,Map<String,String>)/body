{
  final long timeStart=System.currentTimeMillis();
  if (text.length() > maxTextLength) {
    throw new TextTooLongException("Your text exceeds this server's limit of " + maxTextLength + " characters (it's "+ text.length()+ " characters). Please submit a shorter text.");
  }
  final boolean autoDetectLanguage=getLanguageAutoDetect(parameters);
  final Language lang=getLanguage(text,parameters.get("language"),autoDetectLanguage);
  final String motherTongueParam=parameters.get("motherTongue");
  final Language motherTongue=motherTongueParam != null ? Languages.getLanguageForShortName(motherTongueParam) : null;
  final boolean useEnabledOnly="yes".equals(parameters.get("enabledOnly"));
  final String enabledParam=parameters.get("enabled");
  final List<String> enabledRules=new ArrayList<>();
  if (enabledParam != null) {
    enabledRules.addAll(Arrays.asList(enabledParam.split(",")));
  }
  final String disabledParam=parameters.get("disabled");
  final List<String> disabledRules=new ArrayList<>();
  if (disabledParam != null) {
    disabledRules.addAll(Arrays.asList(disabledParam.split(",")));
  }
  if (disabledRules.size() > 0 && useEnabledOnly) {
    throw new IllegalArgumentException("You cannot specify disabled rules using enabledOnly=yes");
  }
  final boolean useQuerySettings=enabledRules.size() > 0 || disabledRules.size() > 0;
  final QueryParams params=new QueryParams(enabledRules,disabledRules,useEnabledOnly,useQuerySettings);
  final Future<List<RuleMatch>> future=executorService.submit(new Callable<List<RuleMatch>>(){
    @Override public List<RuleMatch> call() throws Exception {
      return getRuleMatches(text,parameters,lang,motherTongue,params);
    }
  }
);
  final List<RuleMatch> matches;
  if (maxCheckTimeMillis < 0) {
    matches=future.get();
  }
 else {
    try {
      matches=future.get(maxCheckTimeMillis,TimeUnit.MILLISECONDS);
    }
 catch (    TimeoutException e) {
      boolean cancelled=future.cancel(true);
      throw new RuntimeException("Text checking took longer than allowed maximum of " + maxCheckTimeMillis + " milliseconds (cancelled: "+ cancelled+ ", handleCount: "+ handleCount+ ", queue size: "+ workQueue.size()+ ", language: "+ lang.getShortNameWithCountryAndVariant()+ ", "+ text.length()+ " characters of text)",e);
    }
  }
  setCommonHeaders(httpExchange);
  String xmlResponse=getXmlResponse(text,lang,motherTongue,matches);
  String messageSent="sent";
  String languageMessage=lang.getShortNameWithCountryAndVariant();
  final String referrer=httpExchange.getRequestHeaders().getFirst("Referer");
  try {
    httpExchange.sendResponseHeaders(HttpURLConnection.HTTP_OK,xmlResponse.getBytes(ENCODING).length);
    httpExchange.getResponseBody().write(xmlResponse.getBytes(ENCODING));
    if (motherTongue != null) {
      languageMessage+=" (mother tongue: " + motherTongue.getShortNameWithCountryAndVariant() + ")";
    }
  }
 catch (  IOException exception) {
    messageSent="notSent: " + exception.getMessage();
  }
  String agent=parameters.get("useragent") != null ? parameters.get("useragent") : "-";
  print("Check done: " + text.length() + " chars, "+ languageMessage+ ", "+ referrer+ ", "+ "handlers:"+ handleCount+ ", queue:"+ workQueue.size()+ ", "+ matches.size()+ " matches, "+ (System.currentTimeMillis() - timeStart)+ "ms, agent:"+ agent+ ", "+ messageSent);
}
