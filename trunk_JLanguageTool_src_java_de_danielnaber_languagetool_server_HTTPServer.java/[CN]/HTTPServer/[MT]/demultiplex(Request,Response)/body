{
  long timeStart=System.currentTimeMillis();
  String text=null;
  try {
    if ("".equals(connRequest.getLocation())) {
      connResponse.setStatus(403);
      throw new RuntimeException("Error: Access to " + connRequest.getLocation() + " denied");
    }
    if (allowedIPs.contains(connRequest.getIPAddressString())) {
      String langParam=connRequest.getParamOrNull("language");
      if (langParam == null)       throw new IllegalArgumentException("Missing 'language' parameter");
      Language lang=Language.getLanguageForShortName(langParam);
      if (lang == null)       throw new IllegalArgumentException("Unknown language '" + langParam + "'");
      JLanguageTool lt=new JLanguageTool(lang);
      lt.activateDefaultPatternRules();
      lt.activateDefaultFalseFriendRules();
      text=connRequest.getParamOrNull("text");
      if (text == null)       throw new IllegalArgumentException("Missing 'text' parameter");
      print("Checking " + text.length() + " characters of text, language "+ langParam);
      List<RuleMatch> matches=lt.check(text);
      connResponse.setHeaderLine(ProtocolResponseHeader.Content_Type,"text/xml");
      connResponse.setHeaderLine(ProtocolResponseHeader.Content_Encoding,System.getProperty("file.encoding"));
      String response=StringTools.ruleMatchesToXML(matches,text,CONTEXT_SIZE);
      print("Check done in " + (System.currentTimeMillis() - timeStart) + "ms");
      return response;
    }
 else {
      connResponse.setStatus(403);
      throw new RuntimeException("Error: Access from " + connRequest.getIPAddressString() + " denied");
    }
  }
 catch (  Exception e) {
    if (verbose)     print("Exceptions was caused by this text: " + text);
    e.printStackTrace();
    connResponse.setStatus(500);
    return "Error: " + StringTools.escapeXML(e.toString());
  }
}
