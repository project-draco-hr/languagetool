{
  final SAXParserFactory factory=SAXParserFactory.newInstance();
  factory.setValidating(true);
  final SAXParser saxParser=factory.newSAXParser();
  final String cleanXml=xml.replaceAll("<!DOCTYPE.+>","");
  final String decl="<?xml version=\"1.0\"";
  final String endDecl="?>";
  final URL dtdUrl=this.getClass().getResource(dtdPath);
  if (dtdUrl == null) {
    throw new RuntimeException("DTD not found in classpath: " + dtdPath);
  }
  final String dtd="<!DOCTYPE " + docType + " PUBLIC \"-//W3C//DTD Rules 0.1//EN\" \""+ dtdUrl+ "\">";
  final int pos=cleanXml.indexOf(decl);
  final int endPos=cleanXml.indexOf(endDecl);
  if (pos == -1) {
    throw new IOException("No XML declaration found in '" + cleanXml.substring(0,Math.min(100,cleanXml.length())) + "...'");
  }
  final String newXML=cleanXml.substring(0,endPos + endDecl.length()) + "\r\n" + dtd+ cleanXml.substring(endPos + endDecl.length());
  final InputSource is=new InputSource(new StringReader(newXML));
  saxParser.parse(is,new ErrorHandler());
}
